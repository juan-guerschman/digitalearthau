


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating a New Product &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/dea-favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://unpkg.com/font-awesome@4.5.0/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Git Best Practice" href="git_best_practice.html" />
    <link rel="prev" title="Surface Reflectance" href="../data/data.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/dea-logo-inline.svg" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/changelog.html">DEA NCI Environment Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../connect/account.html">NCI Account Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_modules.html">Other Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/01_Getting_started/README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/02_DEA_datasets/README.html">DEA Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/03_Integrating_external_data/README.html">Integrating External Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/04_Index_calculation/README.html">Index Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/05_Temporal_analysis/README.html">Temporal Analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/06_Composite_generation/README.html">Composite Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/07_Image_classification/README.html">Image Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/08_Outputting_data/README.html">Outputting data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/09_Workflows/README.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/10_Scripts/README.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Supplementary_data/README.html">Supplementary Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data/data.html">Surface Reflectance</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Creating a New Product</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#profile-module-setup">Profile/Module Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-database-access">Test Database Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-new-database">Preparing New Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-new-product">Adding new product</a></li>
<li class="toctree-l2"><a class="reference internal" href="#indexing-data">Indexing data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gotchas">Gotchas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#indexing-fails">Indexing fails</a></li>
<li class="toctree-l3"><a class="reference internal" href="#role-of-metadata">Role of Metadata</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#reviewing-results">Reviewing Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#appendix">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Indexes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Creating a New Product</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/internal/new_product.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="creating-a-new-product">
<h1>Creating a New Product<a class="headerlink" href="#creating-a-new-product" title="Permalink to this headline">¶</a></h1>
<p>Notes for adding new products to NCI datacube</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is still work in progress</p>
</div>
<div class="section" id="profile-module-setup">
<h2>Profile/Module Setup<a class="headerlink" href="#profile-module-setup" title="Permalink to this headline">¶</a></h2>
<p>These instructions assume you have access to the <cite>v10</cite> project on the NCI.</p>
<p>Ensure you have access to both public and private modules, and have loaded
the <cite>dea-prod</cite> module. It makes sense to include the <cite>module use</cite> commands
in your <cite>~/.modulerc</cite> or <cite>~/.bashrc</cite> or <cite>~/.bash_profile</cite>, but run the
<cite>module load</cite> command when required. The <cite>dea-*</cite> module include <cite>DEA</cite>
customised versions of some of the <cite>ODC</cite> management tools.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module use /g/data/v10/private/modules/modulefiles/
module use /g/data/v10/private/modules/modulefiles/
module load dea-prod
</pre></div>
</div>
</div>
<div class="section" id="test-database-access">
<h2>Test Database Access<a class="headerlink" href="#test-database-access" title="Permalink to this headline">¶</a></h2>
<p>Make sure you have access to test database server that allows creation of new
databases. Test database server is <code class="docutils literal notranslate"><span class="pre">agdcdev-db.nci.org.au</span></code>. Configure your
<code class="docutils literal notranslate"><span class="pre">~/.pgpass</span></code>, add new line like this one. Typically you should be able to
re-use the same credentials as your production datacube.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">agdcdev-db.nci.org.au:6432:*:&lt;your user name&gt;:&lt;your random password&gt;</span>
</pre></div>
</div>
<p>Verify that things worked for you
<code class="docutils literal notranslate"><span class="pre">psql</span> <span class="pre">-h</span> <span class="pre">agdcdev-db.nci.org.au</span> <span class="pre">-p</span> <span class="pre">6432</span> <span class="pre">datacube</span> <span class="pre">-l</span></code>,
you should get a list of databases currently present.</p>
</div>
<div class="section" id="preparing-new-database">
<h2>Preparing New Database<a class="headerlink" href="#preparing-new-database" title="Permalink to this headline">¶</a></h2>
<p>It’s best to create an empty database for testing new product. Test database
should contain same metadata and products as the main database. Typically new
product is going to be derived from existing products in the main database and
since we track dataset lineage we need to have the same products in the test
database as in the main.</p>
<p>First create empty database</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mk_db_sql <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">db_name</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    cat <span class="s">&lt;&lt;EOF</span>
<span class="s">CREATE DATABASE ${db_name}</span>
<span class="s">WITH</span>
<span class="s">OWNER = agdc_admin</span>
<span class="s">ENCODING = &#39;UTF8&#39;</span>
<span class="s">LC_COLLATE = &#39;en_AU.UTF-8&#39;</span>
<span class="s">LC_CTYPE = &#39;en_AU.UTF-8&#39;</span>
<span class="s">TABLESPACE = pg_default</span>
<span class="s">CONNECTION LIMIT = -1;</span>

<span class="s">GRANT ALL ON DATABASE ${db_name} TO agdc_admin;</span>
<span class="s">GRANT CONNECT, TEMPORARY ON DATABASE ${db_name} TO PUBLIC;</span>
<span class="s">GRANT ALL ON DATABASE ${db_name} TO test;</span>
<span class="s">ALTER DATABASE ${db_name} SET search_path TO &quot;\$user&quot;, public, agdc;</span>

<span class="s">EOF</span>
<span class="o">}</span>

   <span class="nv">DB_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">_dev&quot;</span> <span class="c1"># change to your liking</span>
   mk_db_sql <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> psql -h agdcdev-db.nci.org.au -p <span class="m">6432</span> datacube
</pre></div>
</div>
<p>Create datacube config file that uses new database</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mk_dev_config <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">db_name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local</span> <span class="nv">f_name</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="p">-</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">db_name</span><span class="si">}</span><span class="s2">.conf&quot;</span><span class="si">}</span>
    cat &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">[datacube]</span>
<span class="s">db_hostname: agdcdev-db.nci.org.au</span>
<span class="s">db_port: 6432</span>
<span class="s">db_database: ${db_name}</span>
<span class="s">EOF</span>
<span class="o">}</span>

   mk_dev_config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Tell datacube to use dev config via environment variable</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DATACUBE_CONFIG_PATH</span><span class="o">=</span><span class="k">$(</span>readlink -f <span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span>.conf<span class="k">)</span>
</pre></div>
</div>
<p>To check this worked run <code class="docutils literal notranslate"><span class="pre">datacube</span> <span class="pre">system</span> <span class="pre">check</span></code> at this point system check
should fail as database is completely empty.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create database with DEA configuration</span>
dea-system init
</pre></div>
</div>
<p>To verify run system check and product list</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>datacube system check
datacube product list
</pre></div>
</div>
</div>
<div class="section" id="adding-new-product">
<h2>Adding new product<a class="headerlink" href="#adding-new-product" title="Permalink to this headline">¶</a></h2>
<p>Products are described using yaml. Things you need to customize</p>
<ol class="arabic simple">
<li>Product name</li>
<li>Product description</li>
<li>Product type</li>
<li>Metadata type (use <code class="docutils literal notranslate"><span class="pre">eo</span></code>) and expected metadata fields</li>
<li>Configure Measurements (data variables): names, types, nodata values, units</li>
</ol>
<p>Note about <code class="docutils literal notranslate"><span class="pre">product_type</span></code> it’s really just a label/tag, an example would be
<code class="docutils literal notranslate"><span class="pre">nbar</span></code> or <code class="docutils literal notranslate"><span class="pre">pqa</span></code>, it is important that datasets are labeled with the exact
same <code class="docutils literal notranslate"><span class="pre">product_type</span></code>. For <code class="docutils literal notranslate"><span class="pre">metadata_type</span></code> use <code class="docutils literal notranslate"><span class="pre">eo</span></code> and a template shown
below, see <a class="reference internal" href="#gotchas">Gotchas</a> section for more info.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;product_name&gt;</span>
<span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;free form description&gt;</span>

<span class="c1"># If unsure use eo</span>
<span class="c1"># platform/instrument are optional, copy from source product</span>
<span class="c1"># or omit if combining products from multiple platforms</span>
<span class="l l-Scalar l-Scalar-Plain">metadata_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">eo</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">product_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;product_type&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">format</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">NetCDF</span>
  <span class="l l-Scalar l-Scalar-Plain">platform</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;e.g. LANDSAT_5&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">instrument</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;e.g. TM&gt;</span>

<span class="l l-Scalar l-Scalar-Plain">measurements</span><span class="p p-Indicator">:</span>
  <span class="c1"># Repeat for all variables</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;variable_name&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">dtype</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;uint16|uint32|float|...&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">nodata</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;optional, needed for integer types usually, -9999 for example&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">units</span><span class="p p-Indicator">:</span> <span class="s">&#39;1&#39;</span> <span class="c1"># Measurement units like &quot;meters&quot;, use &#39;1&#39; if unit-less</span>

<span class="c1"># Typical settings, usually no need to change.</span>
<span class="c1"># For derived products usually good idea to copy source product settings</span>
<span class="c1"># for tile_size and resolution</span>
<span class="l l-Scalar l-Scalar-Plain">storage</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">NetCDFCF</span>
  <span class="l l-Scalar l-Scalar-Plain">crs</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">EPSG:3577</span>
  <span class="l l-Scalar l-Scalar-Plain">tile_size</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">x</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100000.0</span>
    <span class="l l-Scalar l-Scalar-Plain">y</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100000.0</span>
  <span class="l l-Scalar l-Scalar-Plain">resolution</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">x</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">25</span>
    <span class="l l-Scalar l-Scalar-Plain">y</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-25</span>
  <span class="l l-Scalar l-Scalar-Plain">chunking</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">x</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
    <span class="l l-Scalar l-Scalar-Plain">y</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
    <span class="l l-Scalar l-Scalar-Plain">time</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">dimension_order</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">time</span><span class="p p-Indicator">,</span> <span class="nv">y</span><span class="p p-Indicator">,</span> <span class="nv">x</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">NEW_PRODUCT_FILE</span><span class="o">=</span><span class="s2">&quot;&lt;/path/to/product_file.yaml&gt;&quot;</span>
datacube product add <span class="si">${</span><span class="nv">NEW_PRODUCT_FILE</span><span class="si">}</span>

<span class="c1"># Verify it was added</span>
datacube product list
datacube product show <span class="s2">&quot;&lt;product_name&gt;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="indexing-data">
<h2>Indexing data<a class="headerlink" href="#indexing-data" title="Permalink to this headline">¶</a></h2>
<p>For the purpose of this document we are going to assume that product datasets
were generated by the datacube tools and so they are</p>
<ol class="arabic simple">
<li>In NetCDF format</li>
<li>Contain <code class="docutils literal notranslate"><span class="pre">dataset</span></code> description yaml document embedded in them</li>
</ol>
<p>To index datasets into the database just run <code class="docutils literal notranslate"><span class="pre">datacube</span> <span class="pre">dataset</span> <span class="pre">add</span> <span class="pre">&lt;files&gt;</span></code></p>
<p>Test it first with a single file without modifying database</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>datacube dataset add --dry-run <span class="s2">&quot;&lt;path_to_file/some_dataset.nc&gt;&quot;</span>
</pre></div>
</div>
<p>If this succeeds add all files to index</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#flat directory hierarchy</span>
datacube dataset add path_to_datasets/*nc

<span class="c1"># OR if you have extra layer for tiles</span>
datacube dataset add path_to_datasets/**/*nc

<span class="c1"># OR for more complex hierarchies</span>
find path_to_datasets -name <span class="s2">&quot;*nc&quot;</span> <span class="p">|</span> xargs datacube dataset add
</pre></div>
</div>
</div>
<div class="section" id="gotchas">
<h2>Gotchas<a class="headerlink" href="#gotchas" title="Permalink to this headline">¶</a></h2>
<p>Most likely things won’t go smoothly on the first try. This section addresses
some of the more common problem you are likely to experience.</p>
<p>First off these commands will help you debug various problems</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># view info about a NetCDF file</span>
ncdump -h -s <span class="s2">&quot;&lt;dataset_file.nc&gt;&quot;</span>
gdalinfo <span class="s2">&quot;&lt;dataset_file.nc&gt;&quot;</span>

<span class="c1"># view NetCDF file</span>
ncview <span class="s2">&quot;&lt;dataset_file.nc&gt;&quot;</span>

<span class="c1"># view metadata embedded in a NetCDF file</span>
ncks -V -C -v dataset <span class="s2">&quot;&lt;dataset_file.nc&quot;</span>&gt; <span class="p">|</span> less

<span class="c1"># check if datacube uses the right database</span>
datacube system check
</pre></div>
</div>
<div class="section" id="indexing-fails">
<h3>Indexing fails<a class="headerlink" href="#indexing-fails" title="Permalink to this headline">¶</a></h3>
<p>Most likely indexing process failed with <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">matching</span> <span class="pre">Product</span> <span class="pre">found</span> <span class="pre">for</span> <span class="pre">...</span></code>
error message.</p>
<ol class="arabic simple">
<li>Make sure <code class="docutils literal notranslate"><span class="pre">metadata</span></code> section in the product definition matches metadata
embedded in the NetCDF file.</li>
<li>Make sure you are still using dev database</li>
<li>Make sure you have added product successfully</li>
</ol>
</div>
<div class="section" id="role-of-metadata">
<h3>Role of Metadata<a class="headerlink" href="#role-of-metadata" title="Permalink to this headline">¶</a></h3>
<p>Each dataset has a metadata document attached to it, for files produced by the
datacube tools this metadata is automatically generated. See <a class="reference external" href="https://datacube-core.readthedocs.io/en/stable/ops/dataset_documents.html" title="(in Open Data Cube v1.6rc2+0.g0804f26)"><span>Dataset Documents</span></a>
documentation online for a detailed overview.</p>
<p>Metadata embedded inside the NetCDF file is used during indexing process for two purposes</p>
<ol class="arabic simple">
<li>To associate dataset to a product</li>
<li>To populate database search fields (lat/lon, time etc.)</li>
</ol>
<p>When creating product description it is important that <code class="docutils literal notranslate"><span class="pre">metadata</span></code> section is
filled in a way consistent with the metadata present in data files. Usually this
means getting <code class="docutils literal notranslate"><span class="pre">product_type</span></code> right. If your new product is based on data from
one sensor at a time, then you should fill <code class="docutils literal notranslate"><span class="pre">metadata.platform</span></code> and
<code class="docutils literal notranslate"><span class="pre">metadata.instrument</span></code>, failing that you won’t be able to create similar
products for other sensors and still re-use <code class="docutils literal notranslate"><span class="pre">product_type</span></code>. If your product
combines data from multiple sensors/platforms then you should omit
platform/instrument from metadata section.</p>
</div>
</div>
<div class="section" id="reviewing-results">
<h2>Reviewing Results<a class="headerlink" href="#reviewing-results" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Create Virtual Raster files</li>
<li>Create overview files for zoomed out view</li>
<li>Review in QGIS</li>
</ol>
<p>We don’t have generic tools for generating overviews, but here is an example
script for PQ stats. Customise for your needs:</p>
<ol class="arabic simple">
<li>Field names</li>
<li>Glob for file names and grouping by time</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nc_ls <span class="o">()</span> <span class="o">{</span>
    <span class="nv">glob</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">field</span><span class="o">=</span><span class="nv">$2</span>
    <span class="k">for</span> f in <span class="nv">$glob</span><span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;NETCDF:</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">field</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>

mk_overviews_ls_pq <span class="o">()</span> <span class="o">{</span>
    <span class="nv">P</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">-</span><span class="s1">&#39;.&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">Y</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="p">-2014</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nv">VARS</span><span class="o">=</span><span class="s2">&quot;clear_observation_count total_observation_count&quot;</span>
    <span class="nv">glob</span><span class="o">=</span><span class="s2">&quot;LS_PQ_COUNT/**/LS_PQ_COUNT_3577_*_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">*nc&quot;</span>

    <span class="nb">pushd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">P</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> var in <span class="nv">$VARS</span><span class="p">;</span> <span class="k">do</span>
        nc_ls <span class="s2">&quot;</span><span class="si">${</span><span class="nv">glob</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> xargs gdalbuildvrt <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">.vrt&quot;</span>
        gdaladdo -r average <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">.vrt&quot;</span> <span class="m">16</span> <span class="m">32</span> <span class="m">64</span> <span class="m">128</span> <span class="m">256</span>
    <span class="k">done</span>
    <span class="nb">popd</span>
<span class="o">}</span>

   mk_overviews_ls_pq /g/data/u46/users/kk7182/PQ/ <span class="m">2014</span>
</pre></div>
</div>
<p>Create empty QGIS project and add generated <code class="docutils literal notranslate"><span class="pre">*.vrt</span></code> files to it. In the menu
select <code class="docutils literal notranslate"><span class="pre">Layer&gt;</span> <span class="pre">Add</span> <span class="pre">from</span> <span class="pre">Layer</span> <span class="pre">Definition</span> <span class="pre">File...</span></code> navigate to
<code class="docutils literal notranslate"><span class="pre">/g/data/u46/users/kk7182/public/qgis/</span></code> and select <code class="docutils literal notranslate"><span class="pre">au.qlr</span></code>. This will add
vector layer that makes analysis easier.</p>
</div>
<div class="section" id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">set</span> -eu

mk_db_sql <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">db_name</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    cat <span class="s">&lt;&lt;EOF</span>
<span class="s">CREATE DATABASE ${db_name}</span>
<span class="s">WITH</span>
<span class="s">OWNER = agdc_admin</span>
<span class="s">ENCODING = &#39;UTF8&#39;</span>
<span class="s">LC_COLLATE = &#39;en_AU.UTF-8&#39;</span>
<span class="s">LC_CTYPE = &#39;en_AU.UTF-8&#39;</span>
<span class="s">TABLESPACE = pg_default</span>
<span class="s">CONNECTION LIMIT = -1;</span>

<span class="s">GRANT ALL ON DATABASE ${db_name} TO agdc_admin;</span>
<span class="s">GRANT CONNECT, TEMPORARY ON DATABASE ${db_name} TO PUBLIC;</span>
<span class="s">GRANT ALL ON DATABASE ${db_name} TO test;</span>
<span class="s">ALTER DATABASE ${db_name} SET search_path TO &quot;\$user&quot;, public, agdc;</span>

<span class="s">EOF</span>
<span class="o">}</span>

mk_dev_config <span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">db_name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local</span> <span class="nv">f_name</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="p">-</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">db_name</span><span class="si">}</span><span class="s2">.conf&quot;</span><span class="si">}</span>
    cat &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">f_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">[datacube]</span>
<span class="s">db_hostname: agdcdev-db.nci.org.au</span>
<span class="s">db_port: 6432</span>
<span class="s">db_database: ${db_name}</span>
<span class="s">EOF</span>
<span class="o">}</span>

nc_ls <span class="o">()</span> <span class="o">{</span>
    <span class="nv">glob</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">field</span><span class="o">=</span><span class="nv">$2</span>
    <span class="k">for</span> f in <span class="nv">$glob</span><span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;NETCDF:</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">field</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>

mk_overviews_ls_pq <span class="o">()</span> <span class="o">{</span>
    <span class="nv">P</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">-</span><span class="s1">&#39;.&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv">Y</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="p">-2014</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nv">VARS</span><span class="o">=</span><span class="s2">&quot;clear_observation_count total_observation_count&quot;</span>
    <span class="nv">glob</span><span class="o">=</span><span class="s2">&quot;LS_PQ_COUNT/**/LS_PQ_COUNT_3577_*_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">*nc&quot;</span>

    <span class="nb">pushd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">P</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> var in <span class="nv">$VARS</span><span class="p">;</span> <span class="k">do</span>
        nc_ls <span class="s2">&quot;</span><span class="si">${</span><span class="nv">glob</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> xargs gdalbuildvrt <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">.vrt&quot;</span>
        gdaladdo -r average <span class="s2">&quot;</span><span class="si">${</span><span class="nv">var</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">Y</span><span class="si">}</span><span class="s2">.vrt&quot;</span> <span class="m">16</span> <span class="m">32</span> <span class="m">64</span> <span class="m">128</span> <span class="m">256</span>
    <span class="k">done</span>
    <span class="nb">popd</span>
<span class="o">}</span>

example_use <span class="o">()</span> <span class="o">{</span>

   <span class="nv">DB_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">_dev&quot;</span> <span class="c1"># change to your liking</span>
   mk_db_sql <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> psql -h agdcdev-db.nci.org.au -p <span class="m">6432</span> datacube

   mk_dev_config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span><span class="s2">&quot;</span>

   mk_overviews_ls_pq /g/data/u46/users/kk7182/PQ/ <span class="m">2014</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="git_best_practice.html" class="btn btn-neutral float-right" title="Git Best Practice" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../data/data.html" class="btn btn-neutral" title="Surface Reflectance" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Geoscience Australia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.14.0/dist/embed-amd.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>
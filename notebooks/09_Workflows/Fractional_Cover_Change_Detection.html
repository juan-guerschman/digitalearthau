


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fractional Cover: Trend and Variability Analysis &mdash; Digital Earth Australia 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/dea-favicon.ico"/>
  
  
  
    <link rel="canonical" href="https://docs.dea.ga.gov.au/notebooks/09_Workflows/Fractional_Cover_Change_Detection.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.14.0/dist/embed-amd.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://unpkg.com/font-awesome@4.5.0/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fractional Cover Percentiles" href="Fractional_Cover_Percentiles.html" />
    <link rel="prev" title="Sun glint identification and removal" href="Sun_glint_identification_and_removal.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/dea-logo-inline.svg" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/changelog.html">Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Connect</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect/account.html">NCI Account Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/install.html">Installation and Software Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/get_help.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/nci_basics.html">Command Line Usage (Advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect/jupyter.html">Jupyter Notebooks Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/other_modules.html">Other Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../01_Getting_started/README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_DEA_datasets/README.html">DEA Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_Integrating_external_data/README.html">Integrating External Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_Index_calculation/README.html">Index Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_Temporal_analysis/README.html">Temporal Analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_Composite_generation/README.html">Composite Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07_Image_classification/README.html">Image Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_Outputting_data/README.html">Outputting data</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="README.html">Workflows</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="RetrieveLandsat8ViewAndExport.html">View Landsat 8 imagery for a chosen time period</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sun_glint_identification_and_removal.html">Sun glint identification and removal</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fractional Cover: Trend and Variability Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Import-libraries">Import libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#USER-INPUTS">USER INPUTS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Custom-functions">Custom functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Pixel-wise-trend-and-variability-analysis">Pixel-wise trend and variability analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Get-Fractional-Cover-dataset-from-the-DataCube">Get Fractional Cover dataset from the DataCube</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Masking">Masking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#CDO-operations">CDO operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Statistical-tests-(Welch-T-and-Levene)">Statistical tests (Welch-T and Levene)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#CompositeRGB-plot">CompositeRGB plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Exporting-geotiffs">Exporting geotiffs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Zonal-Statistics">Zonal Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Reporting-and-plotting">Reporting and plotting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Zonal-timeseries-plots">Zonal timeseries plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Pixel-wise-plots">Pixel-wise plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#True-colour-plot">True colour plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Merge-all-pdfs">Merge all pdfs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Fractional_Cover_Percentiles.html">Fractional Cover Percentiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="CumulativeMassResidualRainfall.html">Cumulative Mass Residual Rainfall Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Generate_Mangrove_Cover_Statistics_Through_Time.html">Compute 1 km pixel count summaries for Mangrove Cover</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../10_Scripts/README.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Supplementary_data/README.html">Supplementary Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/data.html">Surface Reflectance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data/s3.html">Products Available on Amazon S3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data/s3-sftp.html">Bulk download products from Amazon S3</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/new_product.html">Creating a New Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/git_best_practice.html">Git Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/release.html">DEA Release Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modules.html">DEA Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/collection_management.html">Collection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/requirements_met.html">DEA Code Functionality Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Indexes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Tags Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Digital Earth Australia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="README.html">Workflows</a> &raquo;</li>
        
      <li>Fractional Cover: Trend and Variability Analysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/09_Workflows/Fractional_Cover_Change_Detection.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Fractional-Cover:-Trend-and-Variability-Analysis">
<h1>Fractional Cover: Trend and Variability Analysis<a class="headerlink" href="#Fractional-Cover:-Trend-and-Variability-Analysis" title="Permalink to this headline">¶</a></h1>
<p><strong>Note:</strong> As of August 2018, this notebook requires modification in order to run successfully. Please contact the author (Chad Burton) for assistance prior to running any analyses.</p>
<p><strong>Contents</strong></p>
<p><a class="reference external" href="#readme">Description and readme</a></p>
<p><a class="reference external" href="#userInputs">User Inputs</a></p>
<p><a class="reference external" href="#functions">Custom functions</a></p>
<ol class="arabic">
<li><p class="first"><a class="reference external" href="#pixelWiseAnalysis">Pixel-wise trend and variability analysis</a></p>
<p>1.1 <a class="reference external" href="#get_data">Extract data</a></p>
<p>1.2 <a class="reference external" href="#masking">Masking</a></p>
<p>1.3 <a class="reference external" href="#CDO_operations">CDO operations</a></p>
<p>1.4 <a class="reference external" href="#welch-test">Statistical Tests</a></p>
<p>1.5 <a class="reference external" href="#rgb_plot">Composite RGB</a></p>
<p>1.6 <a class="reference external" href="#export_geotiffs">Export geotiffs</a></p>
</li>
<li><p class="first"><a class="reference external" href="#zonalStats">Zonal statistics</a></p>
</li>
<li><p class="first"><a class="reference external" href="#reporting">Reporting and plotting</a></p>
<p>3.1 <a class="reference external" href="#timeseries">Zonal timeseries plots</a></p>
<p>3.2 <a class="reference external" href="#pixel-wise_plots">Pixel-wise plots</a></p>
<p>3.3 <a class="reference external" href="#truecolourplot">True Colour plot</a></p>
<p>3.4 <a class="reference external" href="#mergeallpdfs">Merge all PDFs</a></p>
</li>
</ol>
<p><strong>Description/Readme</strong></p>
<p><strong>Summary:</strong></p>
<p>This script conducts exploratory timeseries analysis on the Fractional Cover dataset (stored in the Geoscience Australia DataCube) in order to help detect, but not attribute, change in vegetation coverage from seasonal grasss to perennial shrubs and trees. The script conducts the following analysis:</p>
<ol class="arabic simple">
<li>Pixel-wise trend and variability analysis to produce outputs of linear coefficients since some reference time, the change in seasonal and interannual variability between a baseline period and a more recent period, and the difference in mean total vegetation (PV + NPV) between a baseline period and more recent period.</li>
<li>Zonal statistics for n polygons within a shapefile.</li>
<li>Pixel-wise statistical tests to determine where change is significant, these test are applied to both the means (Welch T-test), and the variance (Levene test).</li>
<li>Lastly, an RGB composite map is produced whose bands include: the difference in means, the difference in variability, and the welch-test probabilities. This final map shows regions where strong regeneration from emphemeral pasture to perrenial trees is likely to have occurred.</li>
</ol>
<p>The script relies heavily on the Climate Data Operators (CDO) library to conduct the analysis, which requires loading CDO in the terminal before using this script (run: module load cdo/1.7.1), and installation of the CDO python wrapper. Visit <a class="reference external" href="https://github.com/Try2Code/cdo-bindings">https://github.com/Try2Code/cdo-bindings</a> for instructions on installing CDO-python through the pip installer (this only needs to be done once).</p>
<p>The python packages PyPDF2, and rasterstats are also required and are not pre-installed on the VDI.</p>
<p>Custom modules are also used throughout the script and are available for download from the Geoscience Australia github page <a class="reference external" href="https://github.com/GeoscienceAustralia/dea-notebooks/tree/master/algorithms">https://github.com/GeoscienceAustralia/dea-notebooks/tree/master/algorithms</a>. These include:</p>
<p><em>array_to_geotiff, rasterize_vector, load_masked_FC, dataset_to_geotiff, three_band_image, load_clearlandsat</em></p>
<p><em>Update:</em> These functions are now included at the start of the script after the user inputs section (the script is vastly longer but it doesn’t require any installation of custom modules).</p>
<p>The user should go to the ‘user inputs’ sections at the top of the script and enter the relevant information. Thereafter, the script should not need editing. It is required that a shapefile defining the boundaries for the area of interest is supplied. The shapefile needs some preprocessing before it will run effectively, read part 2 below for more details.</p>
<p><strong>Part 1:</strong></p>
<p>The first part of this script conducts pixel-wise time-series analysis on the fractional cover dataset over a region defined by an input shapefile.</p>
<p>Depending on the size of the region of interest, this script could be run on Raijin to speed up its processing. However, with Dask implemented it will run (almost) any size analysis through the VDI. The script is raijin friendly so exporting it to a .py file should be fine.</p>
<p><em>Nb: Piping of CDO operations is throwing an error, so each step in the analysis is seperated. Piping speeds up the analysis so I should try to resolve this when I get a chance</em></p>
<p><strong>Part 2:</strong></p>
<p>The second part of this script calculates the zonal mean and zonal standard deviation (std dev of the pixel values within the polygon - indication of the range of values within the polygon) of Total Vegetation (PV + NPV) over each seperate polygon in the input shapefile.</p>
<p><strong>This step requires some pre-processing of the input shapefile: an attribute column uniquely identifying ecah polygon must be included. The name of the attribute column needs to be declared in the ‘user inputs’ section. Place this shapefile in your ‘data’ directory.</strong></p>
<p><strong>Part 3:</strong></p>
<p>All results are compiled into a pdf document (called ‘final_results.pdf’) that contains - A true colour map of the area of interest with the shapefile overlaying it - The zonal timeseries for each polygon - Pixel-wise plots showing: the difference between the intra-annual variability in the baseline period compared with the recent period, the levene test p-values, the difference between the mean TV in the basline period and recent period, and Welsh T-test p values on the mean differences - A
binary classification map showing the regions at high-risk of no-regeneration (based on the difference in variability map), and the same plot but masked just to those regions with a levene test p-value &lt;=0.1. The binary classification map is a boolean map of 1’s and 0’s. A 1 indicates areas where regeneration is unlikely to have occurred (areas where the intra-annual variability is higher in the recent period than during the baseline period, likely indicating there has been no transition from
highly seasonal grasses to less climate responsive perennial vegetation (trees and shrubs). - And finally the RGB plot that can be used to find regions where strong regeneration is occurring (regions that are white in the map).</p>
<p>This code was written in April/May of 2018 by Chad Burton, with significant and invaluable help from everyone in Team X and Team Wombat. The notebook was completed as a graduate program project at Geoscience Australia.</p>
<p>Tags: <span class="target" id="index-0"></span>trend, <span class="target" id="index-1"></span>variance, <cite>Welch t-test</cite>, <span class="target" id="index-2"></span>Levene’s test, index:<cite>Climate Data Operators</cite>, <span class="target" id="index-3"></span>PyPDF2, <span class="target" id="index-4"></span>zonal statistics. index:<cite>fractional cover</cite>, <span class="target" id="index-5"></span>terminal operations, <span class="target" id="index-6"></span>rasterstats</p>
<div class="section" id="Import-libraries">
<h2>Import libraries<a class="headerlink" href="#Import-libraries" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Bring in libraries</span>
<span class="kn">import</span> <span class="nn">datacube</span>
<span class="kn">from</span> <span class="nn">datacube.helpers</span> <span class="k">import</span> <span class="n">ga_pq_fuser</span>
<span class="kn">from</span> <span class="nn">datacube.storage</span> <span class="k">import</span> <span class="n">masking</span>
<span class="kn">from</span> <span class="nn">datacube.storage.masking</span> <span class="k">import</span> <span class="n">mask_to_dict</span>
<span class="kn">from</span> <span class="nn">datacube.storage.masking</span> <span class="k">import</span> <span class="n">make_mask</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">gdal</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># sys.path.append(os.path.abspath(&#39;/g/data/u46/users/cb3058/fc_changeDetection/src&#39;))</span>
<span class="c1"># sys.path.append(os.path.abspath(&#39;/g/data/u46/users/cb3058/fc_changeDetection/&#39;))</span>
<span class="c1"># from src import array_to_geotiff</span>
<span class="c1"># from src import rasterize_vector</span>
<span class="c1"># from src import load_nbarx</span>
<span class="c1"># from src import load_masked_FC</span>
<span class="c1"># from src import dataset_to_geotiff</span>
<span class="c1"># from src import three_band_image</span>

<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">from</span> <span class="nn">cdo</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">cdo</span><span class="o">=</span><span class="n">Cdo</span><span class="p">()</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">CDO</span> <span class="o">=</span> <span class="s1">&#39;/apps/cdo/1.7.1/bin/cdo&#39;</span>     <span class="c1">#need to update the location of cdo or else the wrapper can&#39;t find cdo.exe</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="USER-INPUTS">
<h2>USER INPUTS<a class="headerlink" href="#USER-INPUTS" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#enter the filepath locations of the data, results, and working directory (location where you&#39;re running the script from)</span>
<span class="n">results</span> <span class="o">=</span> <span class="s1">&#39;/g/data/u46/users/cb3058/fc_changeDetection/results/&#39;</span>
<span class="n">working_directory</span> <span class="o">=</span> <span class="s1">&#39;/g/data/u46/users/cb3058/fc_changeDetection/&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;data/&#39;</span>

<span class="c1">#Enter the name of project area of interest (string)</span>
<span class="n">project_ID</span> <span class="o">=</span> <span class="s1">&#39;Canberra&#39;</span>

<span class="c1">#Add the filepaths for the project shapefile (string)</span>
<span class="n">shapefile_loc</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;Canberra.shp&#39;</span>

<span class="c1">#name of the attribute column in the shapefile with the uniquely labelled polygons (string)</span>
<span class="n">feature_name</span><span class="o">=</span> <span class="s1">&#39;FeatureNam&#39;</span>

<span class="c1">#start and end date of the timeseries of interest (usually shouldn&#39;t need to change this)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;1988-01-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2017-12-31&#39;</span>

<span class="c1">#enter the year from which regeneration is supposed to have started</span>
<span class="c1">#(i.e. often the model start date, or the date from which land-use changes begun)</span>
<span class="n">start_of_regen</span><span class="o">=</span> <span class="s1">&#39;2012&#39;</span>

<span class="c1">#enter the baseline period (longer is better, but is often 10 years)</span>
<span class="n">start_of_baseline</span> <span class="o">=</span> <span class="s1">&#39;2002&#39;</span>
<span class="n">end_of_baseline</span> <span class="o">=</span> <span class="s1">&#39;2011&#39;</span>

<span class="c1">#set the number of chunks to pass to dask</span>
<span class="c1">#(bigger chunks will run the dc_load faster, but be careful of hitting memory limits)</span>
<span class="n">ds_chunks</span> <span class="o">=</span> <span class="mi">40</span>

<span class="c1">## Set cloud threshold. This value defines the amount of lansdcape/cloud allowed in each scene.</span>
<span class="c1">#Scenes will not be retrieved that have less than the cloud threshold worth of image.</span>
<span class="n">cloud_free_threshold</span> <span class="o">=</span> <span class="mf">0.80</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Custom-functions">
<h2>Custom functions<a class="headerlink" href="#Custom-functions" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datacube.helpers</span> <span class="k">import</span> <span class="n">ga_pq_fuser</span>
<span class="kn">from</span> <span class="nn">datacube.storage</span> <span class="k">import</span> <span class="n">masking</span>
<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="k">def</span> <span class="nf">load_clearlandsat</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">masked_prop</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">sensors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ls5&#39;</span><span class="p">,</span> <span class="s1">&#39;ls7&#39;</span><span class="p">,</span> <span class="s1">&#39;ls8&#39;</span><span class="p">],</span> <span class="n">mask_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># List to save results from each sensor</span>
    <span class="n">filtered_sensors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate through all sensors, returning only observations with &gt; mask_prop clear pixels</span>
    <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensors</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Lazily load Landsat data using dask</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{}</span><span class="s1"> PQ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_nbart_albers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span>
                        <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span>
                        <span class="n">dask_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                        <span class="o">**</span><span class="n">query</span><span class="p">)</span>

            <span class="c1"># Remove measurements variable from query so that PQ load doesn&#39;t fail</span>
            <span class="n">pq_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;measurements&#39;</span> <span class="ow">in</span> <span class="n">pq_query</span><span class="p">:</span> <span class="k">del</span> <span class="n">pq_query</span><span class="p">[</span><span class="s1">&#39;measurements&#39;</span><span class="p">]</span>

            <span class="c1"># Load PQ data</span>
            <span class="n">pq</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_pq_albers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">),</span>
                         <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;solar_day&#39;</span><span class="p">,</span>
                         <span class="n">fuse_func</span><span class="o">=</span><span class="n">ga_pq_fuser</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">pq_query</span><span class="p">)</span>

            <span class="c1"># Return only Landsat observations that have matching PQ data (this may</span>
            <span class="c1"># need to be improved, but seems to work in most cases)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

            <span class="c1"># If a custom dict is provided for mask_dict, use these values to make mask from PQ</span>
            <span class="k">if</span> <span class="n">mask_dict</span><span class="p">:</span>

                <span class="c1"># Mask PQ using custom values by unpacking mask_dict **kwarg</span>
                <span class="n">good_quality</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">make_mask</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">pixelquality</span><span class="p">,</span> <span class="o">**</span><span class="n">mask_dict</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Identify pixels with no clouds in either ACCA for Fmask</span>
                <span class="n">good_quality</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">make_mask</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">pixelquality</span><span class="p">,</span>
                                                 <span class="n">cloud_acca</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
                                                 <span class="n">cloud_fmask</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
                                                 <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Compute good data for each observation as a percentage of total array pixels</span>
            <span class="n">data_perc</span> <span class="o">=</span> <span class="n">good_quality</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">good_quality</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">good_quality</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># Add data_perc data to Landsat dataset as a new xarray variable</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_perc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data_perc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)])</span>

            <span class="c1"># Filter and finally import data using dask</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_perc</span> <span class="o">&gt;=</span> <span class="n">masked_prop</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Loading </span><span class="si">{}</span><span class="s1"> filtered </span><span class="si">{}</span><span class="s1"> timesteps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">sensor</span><span class="p">))</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

            <span class="c1"># Append result to list</span>
            <span class="n">filtered_sensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="c1"># If there is no data for sensor or if another error occurs:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Skipping </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor</span><span class="p">))</span>

    <span class="c1"># Concatenate all sensors into one big xarray dataset, and then sort by time</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combining and sorting ls5, ls7 and ls8 data&#39;</span><span class="p">)</span>
    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">filtered_sensors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># Return combined dataset</span>
    <span class="k">return</span> <span class="n">combined_ds</span>



<span class="kn">import</span> <span class="nn">datacube</span>
<span class="kn">from</span> <span class="nn">datacube.helpers</span> <span class="k">import</span> <span class="n">ga_pq_fuser</span>
<span class="kn">from</span> <span class="nn">datacube.storage</span> <span class="k">import</span> <span class="n">masking</span>
<span class="kn">from</span> <span class="nn">datacube.storage.masking</span> <span class="k">import</span> <span class="n">mask_to_dict</span>
<span class="kn">from</span> <span class="nn">datacube.storage.masking</span> <span class="k">import</span> <span class="n">make_mask</span>

<span class="n">dc</span> <span class="o">=</span> <span class="n">datacube</span><span class="o">.</span><span class="n">Datacube</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="s1">&#39;fc_fun&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_masked_FC</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cloud_free_threshold</span><span class="p">):</span>
    <span class="c1">#print(&#39;loading {}&#39;.format(sensor)</span>

    <span class="n">basic_pq_mask</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cloud_acca&#39;</span><span class="p">:</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cloud_shadow_acca&#39;</span> <span class="p">:</span><span class="s1">&#39;no_cloud_shadow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cloud_shadow_fmask&#39;</span> <span class="p">:</span> <span class="s1">&#39;no_cloud_shadow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cloud_fmask&#39;</span> <span class="p">:</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span>
    <span class="s1">&#39;blue_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;green_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;red_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;nir_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;swir1_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;swir2_saturated&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;contiguous&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;land_sea&#39;</span><span class="p">:</span> <span class="s1">&#39;land&#39;</span><span class="p">}</span>

    <span class="c1"># load FC and PQ</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="p">(</span><span class="n">sensor</span> <span class="o">+</span> <span class="s1">&#39;_fc_albers&#39;</span><span class="p">),</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;solar_day&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="p">(</span><span class="n">sensor</span> <span class="o">+</span> <span class="s1">&#39;_pq_albers&#39;</span><span class="p">),</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;solar_day&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">,</span> <span class="n">fuse_func</span><span class="o">=</span><span class="n">ga_pq_fuser</span><span class="p">)</span>

    <span class="n">crs</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">crswkt</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">wkt</span>
    <span class="n">affine</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">affine</span>

    <span class="c1"># find common observations</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">pq</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">time</span>  <span class="c1"># works!</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># mask</span>
    <span class="n">basic_mask</span> <span class="o">=</span> <span class="n">make_mask</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="o">**</span><span class="n">basic_pq_mask</span><span class="p">)</span><span class="o">.</span><span class="n">pixelquality</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">basic_mask</span><span class="p">)</span>
    <span class="n">cloud_free</span> <span class="o">=</span> <span class="n">make_mask</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="n">cloud_acca</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span> <span class="n">cloud_fmask</span><span class="o">=</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pixelquality</span>

    <span class="c1">#filter with cloud free threshold to remove cloudy scenes</span>
    <span class="n">mostly_cloud_free</span> <span class="o">=</span> <span class="n">cloud_free</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">cloud_free_threshold</span>

    <span class="c1"># only those observations that were mostly cloud free</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mostly_cloud_free</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crs</span>
    <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;affine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">affine</span>
    <span class="k">return</span> <span class="n">result</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">rasterize_vector</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">,</span>
                     <span class="n">projection</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raster_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rasterize a vector file and return an array with values for cells that occur within the shapefile.</span>
<span class="sd">    Can be used to obtain a binary array (shapefile vs no shapefile), or can assign the array cells with</span>
<span class="sd">    values from the shaepfile features by supplying the name of a shapefile field (&#39;field). If &#39;raster_path&#39;</span>
<span class="sd">    is provided, the resulting array can be output as a geotiff raster.</span>

<span class="sd">    This function requires dimensions, projection data (in &quot;WKT&quot; format) and geotransform info</span>
<span class="sd">    (&quot;(upleft_x, x_size, x_rotation, upleft_y, y_rotation, y_size)&quot;) for the output array.</span>
<span class="sd">    These are typically obtained from an existing raster using the following GDAL calls:</span>

<span class="sd">    # import gdal</span>
<span class="sd">    # gdal_dataset = gdal.Open(raster_path)</span>
<span class="sd">    # geotrans = gdal_dataset.GetGeoTransform()</span>
<span class="sd">    # prj = gdal_dataset.GetProjection()</span>
<span class="sd">    # out_array = gdal_dataset.GetRasterBand(1).ReadAsArray()</span>
<span class="sd">    # yrows, xcols = out_array.shape</span>

<span class="sd">    Last modified: April 2018</span>
<span class="sd">    Author: Robbi Bishop-Taylor</span>

<span class="sd">    :attr input_data: input shapefile path or preloaded GDAL/OGR layer</span>
<span class="sd">    :attr cols: desired width of output array in columns. This can be obtained from an existing</span>
<span class="sd">                array using &#39;.shape[0]&#39;)</span>
<span class="sd">    :attr rows: desired height of output array in rows. This can be obtained from an existing</span>
<span class="sd">                array using &#39;.shape[1]&#39;)</span>
<span class="sd">    :attr geo_transform: geotransform for output raster;</span>
<span class="sd">                 e.g. &quot;(upleft_x, x_size, x_rotation, upleft_y, y_rotation, y_size)&quot;</span>
<span class="sd">    :attr projection: projection for output raster (in &quot;WKT&quot; format)</span>
<span class="sd">    :attr field: shapefile field to rasterize values from. If none given (default), this</span>
<span class="sd">                 assigns a value of 1 to all array cells within the shapefile, and 0 to</span>
<span class="sd">                 areas outside the shapefile</span>

<span class="sd">    :returns: a &#39;row x col&#39; array containing values from vector</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If input data is a string, import as shapefile layer</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Open vector with gdal</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">OpenEx</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">OF_VECTOR</span><span class="p">)</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">GetLayer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If raster path supplied, save rasterized file as a geotiff</span>
    <span class="k">if</span> <span class="n">raster_path</span><span class="p">:</span>

        <span class="c1"># Set up output raster</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exporting raster to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raster_path</span><span class="p">))</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
        <span class="n">target_ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">raster_path</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_UInt16</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># If no raster path, create raster as memory object</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;MEM&#39;</span><span class="p">)</span>  <span class="c1"># In memory dataset</span>
        <span class="n">target_ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_UInt16</span><span class="p">)</span>

    <span class="c1"># Set geotransform and projection</span>
    <span class="n">target_ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geo_transform</span><span class="p">)</span>
    <span class="n">target_ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="c1"># Rasterize shapefile and extract array using field if supplied; else produce binary array</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="n">gdal</span><span class="o">.</span><span class="n">RasterizeLayer</span><span class="p">(</span><span class="n">target_ds</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ATTRIBUTE=&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdal</span><span class="o">.</span><span class="n">RasterizeLayer</span><span class="p">(</span><span class="n">target_ds</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_data</span><span class="p">)</span>

    <span class="n">band</span> <span class="o">=</span> <span class="n">target_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out_array</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="n">target_ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">out_array</span>


<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">exposure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">three_band_image</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">contrast_enhance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    threeBandImage takes three spectral bands and plots them on the RGB bands of an</span>
<span class="sd">    image.</span>

<span class="sd">    Last modified: March 2018</span>
<span class="sd">    Author: Mike Barnes</span>
<span class="sd">    Modified by: Claire Krause, Cate Kooymans</span>
<span class="sd">    Inputs:</span>
<span class="sd">    ds -   Dataset containing the bands to be plotted</span>
<span class="sd">    bands - list of three bands to be plotted</span>

<span class="sd">    Optional:</span>
<span class="sd">    time - Index value of the time dimension of ds to be plotted</span>
<span class="sd">    figsize - dimensions for the output figure</span>
<span class="sd">    contrast_enhance - determines the transformation for plotting onto RGB. If contrast_enhance = true,</span>
<span class="sd">                       exposure.equalize_hist is used to trasnform the data. Else, the data are</span>
<span class="sd">                       standardised relative to reflectance = 5000.</span>
<span class="sd">    title - string for the plot title. If nothing is given, it will print the names of the</span>
<span class="sd">            bands being plotted.</span>
<span class="sd">    projection - options are &#39;projected&#39; or &#39;geographic&#39;. To determine if the image is</span>
<span class="sd">                in degrees or northings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">rawimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
            <span class="n">rawimg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">colour</span><span class="p">][</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">rawimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
            <span class="n">rawimg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">colour</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">rawimg</span><span class="p">[</span><span class="n">rawimg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">contrast_enhance</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">img_toshow</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">equalize_hist</span><span class="p">(</span><span class="n">rawimg</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rawimg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_toshow</span> <span class="o">=</span> <span class="n">rawimg</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_toshow</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                          <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Time&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">time</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt</span><span class="p">,</span> <span class="n">fig</span>


<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geo_transform</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span>
                     <span class="n">nodata_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a single band GeoTIFF file with data from an array.</span>

<span class="sd">    Because this works with simple arrays rather than xarray datasets from DEA, it requires</span>
<span class="sd">    geotransform info (&quot;(upleft_x, x_size, x_rotation, upleft_y, y_rotation, y_size)&quot;) and</span>
<span class="sd">    projection data (in &quot;WKT&quot; format) for the output raster. These are typically obtained from</span>
<span class="sd">    an existing raster using the following GDAL calls:</span>

<span class="sd">    # import gdal</span>
<span class="sd">    # gdal_dataset = gdal.Open(raster_path)</span>
<span class="sd">    # geotrans = gdal_dataset.GetGeoTransform()</span>
<span class="sd">    # prj = gdal_dataset.GetProjection()</span>

<span class="sd">    ...or alternatively, directly from an xarray dataset:</span>

<span class="sd">    # geotrans = xarraydataset.geobox.transform.to_gdal()</span>
<span class="sd">    # prj = xarraydataset.geobox.crs.wkt</span>

<span class="sd">    Last modified: March 2018</span>
<span class="sd">    Author: Robbi Bishop-Taylor</span>

<span class="sd">    :attr fname: output file path</span>
<span class="sd">    :attr data: input array</span>
<span class="sd">    :attr geo_transform: geotransform for output raster;</span>
<span class="sd">                             e.g. &quot;(upleft_x, x_size, x_rotation, upleft_y, y_rotation, y_size)&quot;</span>
<span class="sd">    :attr projection: projection for output raster (in &quot;WKT&quot; format)</span>
<span class="sd">    :attr nodata_val: value to convert to nodata in output raster; default 0</span>
<span class="sd">    :attr dtype: value to convert to nodata in output raster; default gdal.GDT_Float32</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set up driver</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>

    <span class="c1"># Create raster of given size and projection</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geo_transform</span><span class="p">)</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="c1"># Write data to array and set nodata values</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">band</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">nodata_val</span><span class="p">)</span>

    <span class="c1"># Close file</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>


<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rasterio</span>

<span class="k">def</span> <span class="nf">dataset_to_geotiff</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
              <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span><span class="p">),</span>  <span class="c1"># geomedian no time dim</span>
              <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
              <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">crs_str</span><span class="p">,</span>
              <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
              <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
              <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s1">&#39;compress&#39;</span><span class="p">:</span> <span class="s1">&#39;deflate&#39;</span><span class="p">,</span> <span class="s1">&#39;zlevel&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;predictor&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span><span class="p">):</span>
            <span class="n">src</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Pixel-wise-trend-and-variability-analysis">
<h1>Pixel-wise trend and variability analysis<a class="headerlink" href="#Pixel-wise-trend-and-variability-analysis" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>Functioning code, nothing should need to be changed from here onwards</div></blockquote>
<div class="section" id="Get-Fractional-Cover-dataset-from-the-DataCube">
<h2>Get Fractional Cover dataset from the DataCube<a class="headerlink" href="#Get-Fractional-Cover-dataset-from-the-DataCube" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#create subdirectories in the results folder for all the outputs</span>
<span class="c1">#folder in results labelled by the project_ID</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results</span><span class="o">+</span> <span class="n">project_ID</span><span class="p">)</span>
<span class="c1">#netcdfs</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;results/&#39;</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/netcdfs&#39;</span><span class="p">)</span>
<span class="c1">#tiffs</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;results/&#39;</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/geotiffs&#39;</span><span class="p">)</span>
<span class="c1">#pdfs (seperate folder for the timeseries plots)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;results/&#39;</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/pdfs&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;results/&#39;</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/pdfs/ts&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#assign the results directories as variables</span>
<span class="c1">#netcdfs</span>
<span class="n">results_netcdf</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/netcdfs/&#39;</span>
<span class="c1">#tiffs</span>
<span class="n">tiff_results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/geotiffs/&#39;</span>
<span class="c1">#pdfs (seperate folder for the timeseries plots)</span>
<span class="n">results_pdf</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/pdfs/&#39;</span>
<span class="n">results_ts_pdf</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/pdfs/ts/&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">########################</span>
<span class="c1">#Create a datacube query</span>
<span class="c1">########################</span>

<span class="c1">#import project area shapefiles</span>
<span class="n">project_area</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_loc</span><span class="p">)</span>

<span class="c1">#convert the shapefile to GDA94 lat-long coords so we can query dc_load using lat long</span>
<span class="n">project_area</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_area</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4283</span><span class="p">)</span>

<span class="c1">#find the bounding box that contains all the queried projects</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">project_area</span><span class="o">.</span><span class="n">total_bounds</span>
<span class="c1">#longitude</span>
<span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">extent_long</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>  <span class="c1">#+ [-0.025, 0.025]</span>
<span class="n">extent_long</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extent_long</span><span class="p">)</span>
<span class="c1">#latitude</span>
<span class="n">ind1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">extent_lat</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="c1">#+ [-0.025, 0.025]</span>
<span class="n">extent_lat</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extent_lat</span><span class="p">)</span>

<span class="c1">#datacube query is created</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">),}</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent_long</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent_lat</span>
<span class="n">query</span><span class="p">[</span><span class="s1">&#39;dask_chunks&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="n">ds_chunks</span><span class="p">}</span> <span class="c1">#divide query into chunks to save memory</span>
<span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
I am densified (external_values, 2 elements)
{&#39;time&#39;: (&#39;1988-01-01&#39;, &#39;2017-12-31&#39;), &#39;x&#39;: (149.06983723046062, 149.19605921253344), &#39;y&#39;: (-35.366078590309321, -35.264919824772527), &#39;dask_chunks&#39;: {&#39;time&#39;: 40}}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#######################</span>
<span class="c1">#Get data using dc.load</span>
<span class="c1">#######################</span>

<span class="c1"># Function for extracting the FC data is is a .py file in the &#39;src&#39; folder</span>
<span class="c1"># only extracting a single sensor at a time with this function as dask will break if</span>
<span class="c1"># you try to concatentate multiple sensors together</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="n">dask</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

<span class="n">fc_clean_ls5</span> <span class="o">=</span> <span class="n">load_masked_FC</span><span class="p">(</span><span class="s1">&#39;ls5&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cloud_free_threshold</span><span class="p">)</span>
<span class="n">fc_clean_ls7</span> <span class="o">=</span> <span class="n">load_masked_FC</span><span class="p">(</span><span class="s1">&#39;ls7&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cloud_free_threshold</span><span class="p">)</span>
<span class="n">fc_clean_ls8</span> <span class="o">=</span> <span class="n">load_masked_FC</span><span class="p">(</span><span class="s1">&#39;ls8&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cloud_free_threshold</span><span class="p">)</span>

<span class="c1">#Add a Total Vegetation variable that is the combination of PV and NPV</span>
<span class="n">fc_clean_ls5</span><span class="p">[</span><span class="s1">&#39;TV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc_clean_ls5</span><span class="o">.</span><span class="n">PV</span> <span class="o">+</span> <span class="n">fc_clean_ls5</span><span class="o">.</span><span class="n">NPV</span>
<span class="n">fc_clean_ls7</span><span class="p">[</span><span class="s1">&#39;TV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc_clean_ls7</span><span class="o">.</span><span class="n">PV</span> <span class="o">+</span> <span class="n">fc_clean_ls7</span><span class="o">.</span><span class="n">NPV</span>
<span class="n">fc_clean_ls8</span><span class="p">[</span><span class="s1">&#39;TV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc_clean_ls8</span><span class="o">.</span><span class="n">PV</span> <span class="o">+</span> <span class="n">fc_clean_ls8</span><span class="o">.</span><span class="n">NPV</span>

<span class="c1">#export out netcdf filed for merging in cdo, use datacube function not xarray function</span>
<span class="n">datacube</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write_dataset_to_netcdf</span><span class="p">(</span><span class="n">fc_clean_ls5</span><span class="p">,</span> <span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;fc_clean_ls5.nc&#39;</span><span class="p">)</span>
<span class="n">datacube</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write_dataset_to_netcdf</span><span class="p">(</span><span class="n">fc_clean_ls7</span><span class="p">,</span> <span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;fc_clean_ls7.nc&#39;</span><span class="p">)</span>
<span class="n">datacube</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write_dataset_to_netcdf</span><span class="p">(</span><span class="n">fc_clean_ls8</span><span class="p">,</span> <span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;fc_clean_ls8.nc&#39;</span><span class="p">)</span>

<span class="c1">#######################################</span>
<span class="c1">#Concatenate and clean up the timeseries</span>
<span class="c1">#######################################</span>

<span class="c1">#merge the timeseries together using cdo</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">results_netcdf</span><span class="p">)</span>

<span class="n">ifile</span> <span class="o">=</span> <span class="s1">&#39;fc_clean_ls5.nc&#39;</span>
<span class="n">ifile1</span> <span class="o">=</span> <span class="s1">&#39;fc_clean_ls7.nc&#39;</span>
<span class="n">ifile2</span> <span class="o">=</span> <span class="s1">&#39;fc_clean_ls8.nc&#39;</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="s1">&#39;fc_clean_allobs.nc&#39;</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">mergetime</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ifile</span><span class="p">,</span><span class="n">ifile1</span><span class="p">,</span><span class="n">ifile2</span><span class="p">)),</span> <span class="n">output</span><span class="o">=</span><span class="n">ofile</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Masking">
<h2>Masking<a class="headerlink" href="#Masking" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#########################</span>
<span class="c1">#---------Masking--------</span>
<span class="c1">#########################</span>
<span class="c1">#reimport netcdf file for masking operation</span>
<span class="n">fc_clean_allobs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;fc_clean_allobs.nc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">})</span>

<span class="c1">#reload, reproject, and export the shapefile (so we can use it for masking in the next step)</span>
<span class="c1">#load</span>
<span class="n">project_area_CEA</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shapefile_loc</span><span class="p">)</span>
<span class="c1">#convert the shapefile to albers equal area coords</span>
<span class="n">project_area_CEA</span> <span class="o">=</span> <span class="n">project_area_CEA</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3577</span><span class="p">)</span>
<span class="c1">#export out converted shapefile</span>
<span class="n">project_area_CEA</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;_cea_albers.shp&#39;</span><span class="p">)</span>

<span class="c1">#Rasterize shapefile vector for masking:</span>
<span class="c1">#find the &#39;wkt&#39; for GDA94 Albers Equal Area</span>
<span class="kn">import</span> <span class="nn">osr</span>
<span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
<span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">3577</span><span class="p">)</span>
<span class="n">prj_wkt</span> <span class="o">=</span> <span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">()</span>

<span class="c1">#find the width and height of the xarray dataset we want to mask</span>
<span class="n">width</span><span class="p">,</span><span class="n">height</span> <span class="o">=</span> <span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">TV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="c1">#define the location of the shapefile we&#39;re converting</span>
<span class="n">project_area_CEA_albers_loc</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;_cea_albers.shp&#39;</span>

<span class="c1">#create &#39;transform&#39; tuple that will define the dimensions of the rasterized shapefile</span>
<span class="n">easting</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">W_E_pixelRes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">rotation</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#(if image is &#39;north up&#39;)</span>
<span class="n">northing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">rotation1</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#(if image is &#39;north up&#39;)</span>
<span class="n">N_S_pixelRes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">transform</span> <span class="o">=</span> <span class="p">(</span><span class="n">easting</span><span class="p">,</span> <span class="n">W_E_pixelRes</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">northing</span><span class="p">,</span> <span class="n">rotation1</span><span class="p">,</span> <span class="n">N_S_pixelRes</span><span class="p">)</span>

<span class="c1"># rasterize vector</span>
<span class="n">project_cea_raster</span> <span class="o">=</span> <span class="n">rasterize_vector</span><span class="p">(</span><span class="n">project_area_CEA_albers_loc</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span>
                     <span class="n">prj_wkt</span><span class="p">,</span> <span class="n">raster_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Mask the xarray</span>
<span class="n">fc_clean_masked</span> <span class="o">=</span> <span class="n">fc_clean_allobs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">project_cea_raster</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
I am densified (external_values, 2 elements)
</pre></div></div>
</div>
</div>
<div class="section" id="CDO-operations">
<h2>CDO operations<a class="headerlink" href="#CDO-operations" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">################################</span>
<span class="c1"># Trend and Variability analysis</span>
<span class="c1">################################</span>

<span class="c1"># resample to the monthly scale so we have a equal interval timeseries for the trend analysis</span>
<span class="c1"># This also helps reduce the size of the dataset which speeds up operations. But it also reduces the</span>
<span class="c1"># number of datapoints for the variability analysis, so there&#39;s a tradeoff here.</span>
<span class="n">fc_clean_monthly</span> <span class="o">=</span> <span class="n">fc_clean_masked</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="c1">#export out netcdf for cdo operations</span>
<span class="n">fc_clean_monthly</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;fc_clean_monthly.nc&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

<span class="c1">#use CDO to do the pixel-wise analysis</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">results_netcdf</span><span class="p">)</span>
<span class="c1">#long term trends and variability</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">settaxis</span><span class="p">(</span><span class="n">start_date</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-16,12:00:00,1mon&#39;</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;fc_clean_monthly.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;fc_ready.nc&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="s1">&#39;-r&#39;</span><span class="p">)</span> <span class="c1">#fix the time axis</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">selyear</span><span class="p">(</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;fc_ready.nc&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timmean</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timstd</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">trend</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;intercept&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="s1">&#39;slope&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>    <span class="c1">#calculate pixel-wise linear coefficients and intercepts</span>

<span class="c1">#recent trends and variability</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">selyear</span><span class="p">(</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;fc_ready.nc&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timmean</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timstd</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">trend</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;intercept&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="s1">&#39;slope&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>

<span class="c1">#differnce in the means between the two periods</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span> <span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span> <span class="s1">&#39;mean&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean_diff.nc&#39;</span><span class="p">)</span>

<span class="c1">#---------further analysis (not necessarily using all this data)----------</span>
<span class="c1">#inter AND intra-annual variability test</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span><span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span> <span class="s1">&#39;std&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;std_diff.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s1">&#39;&quot;noRegen=(TV&lt;=0)&quot;&#39;</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;std_diff.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;noRegen_interannual.nc&#39;</span><span class="p">)</span>

<span class="c1">#intra-annual variability only test</span>
<span class="c1">#long-term</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">yearstd</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;yearly_std_baseline.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timmean</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;yearly_std_baseline.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean_yearly_std_baseline.nc&#39;</span><span class="p">)</span>
<span class="c1">#recent intraannual std:</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">yearstd</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;yearly_std_regen_period.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">timmean</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;yearly_std_regen_period.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean_yearly_std_regen_period.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;mean_yearly_std_baseline.nc mean_yearly_std_regen_period.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;mean_yearly_std_diff.nc&#39;</span><span class="p">)</span>
<span class="n">cdo</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s1">&#39;&quot;noRegen=(TV&lt;=0)&quot;&#39;</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;mean_yearly_std_diff.nc&#39;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;noRegen_intraannual.nc&#39;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/ipykernel_launcher.py:8: DeprecationWarning:
.resample() has been modified to defer calculations. Instead of passing &#39;dim&#39; and &#39;how=&#34;mean&#34;, instead consider using .resample(time=&#34;M&#34;).mean()

/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/xarray/core/common.py:619: FutureWarning: pd.TimeGrouper is deprecated and will be removed; Please use pd.Grouper(freq=...)
  label=label, base=base)
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/dask/array/numpy_compat.py:46: RuntimeWarning: invalid value encountered in true_divide
  x = np.divide(x1, x2, out)
</pre></div></div>
</div>
</div>
<div class="section" id="Statistical-tests-(Welch-T-and-Levene)">
<h2>Statistical tests (Welch-T and Levene)<a class="headerlink" href="#Statistical-tests-(Welch-T-and-Levene)" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#bring in data</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span><span class="n">start_of_baseline</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_of_baseline</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">TV</span>

<span class="n">recent</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">recent</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">TV</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define a function for calculating the t-stat</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="k">def</span> <span class="nf">t_test_grid</span><span class="p">(</span><span class="n">xarray_a</span><span class="p">,</span> <span class="n">xarray_b</span><span class="p">,</span> <span class="n">equal_variance</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span> <span class="s1">&#39;omit&#39;</span><span class="p">,</span> <span class="n">mask_not_sig</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">level_of_sig</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function has two components:</span>
<span class="sd">    1.  A two-sided T-test for the null hypothesis that 2 independent samples have identical average (expected) values.</span>
<span class="sd">        This test assumes that the populations have unequal variances by default.</span>

<span class="sd">    2. Levene Stat tests the null hypothesis that all input samples are from populations with equal variances.</span>

<span class="sd">    See scipy.stats.ttest_ind and scipy.stats.levene for info on the variables in the function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#convert into numpy ndarray arrays</span>
    <span class="n">arr_1</span> <span class="o">=</span> <span class="n">xarray_a</span><span class="o">.</span><span class="n">values</span>
    <span class="n">arr_2</span> <span class="o">=</span> <span class="n">xarray_b</span><span class="o">.</span><span class="n">values</span>
    <span class="c1">#run the t-test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting T-test&#39;</span><span class="p">)</span>
    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">arr_1</span><span class="p">,</span> <span class="n">arr_2</span><span class="p">,</span> <span class="n">equal_var</span> <span class="o">=</span> <span class="n">equal_variance</span><span class="p">,</span> <span class="n">nan_policy</span> <span class="o">=</span> <span class="n">nan_policy</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished T-test&#39;</span><span class="p">)</span>

    <span class="c1">#create empty arrays to put the F-stat results in</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">arr_1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">arr_2</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">x1</span> <span class="o">==</span> <span class="n">x2</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">==</span> <span class="n">y2</span>
    <span class="n">levene_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>
    <span class="n">levene_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">))</span>
    <span class="c1">#loop through each cell of arr1 and arr2 to conduct the levene test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting for-loop...I am thinking&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y1</span><span class="p">):</span>
            <span class="n">arr_3</span> <span class="o">=</span> <span class="n">arr_1</span><span class="p">[:,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="c1">#for each x,y position, create a 1D array of the timeseries</span>
            <span class="n">arr_4</span> <span class="o">=</span> <span class="n">arr_2</span><span class="p">[:,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">arr_3</span> <span class="o">=</span> <span class="n">arr_3</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr_3</span><span class="p">)]</span> <span class="c1">#deal with the nans</span>
            <span class="n">arr_4</span> <span class="o">=</span> <span class="n">arr_4</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr_4</span><span class="p">)]</span>
            <span class="n">levene_f</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="n">levene_p</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">levene</span><span class="p">(</span><span class="n">arr_3</span><span class="p">,</span> <span class="n">arr_4</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span> <span class="c1">#run the test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished levene test&#39;</span><span class="p">)</span>

    <span class="c1">#Get coordinates from the original xarray</span>
    <span class="n">lat</span>  <span class="o">=</span> <span class="n">xarray_a</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">long</span> <span class="o">=</span> <span class="n">xarray_a</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="c1">#Mask out values with insignificant trends (ie. p-value &gt; 0.05) if user wants</span>
    <span class="k">if</span> <span class="n">mask_not_sig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t_stat</span><span class="p">[</span><span class="n">p_values</span><span class="o">&gt;</span><span class="n">level_of_sig</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">levene_f</span><span class="p">[</span><span class="n">levene_p</span><span class="o">&gt;</span><span class="n">level_of_sig</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1">#Write arrays into a x-array</span>
    <span class="n">t_stat_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">t_stat</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">],</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;t_stats&#39;</span><span class="p">)</span>
    <span class="n">p_val_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">],</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p_value&#39;</span><span class="p">)</span>
    <span class="n">f_stat_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">levene_f</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">],</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;f_stats&#39;</span><span class="p">)</span>
    <span class="n">p_val_f_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">levene_p</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">],</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p_value_f&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t_stat_xr</span><span class="p">,</span> <span class="n">p_val_xr</span><span class="p">,</span> <span class="n">f_stat_xr</span><span class="p">,</span> <span class="n">p_val_f_xr</span>

<span class="c1">#run function</span>
<span class="n">t_stat_masked</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">levene_stat_masked</span><span class="p">,</span> <span class="n">p_values_levene</span> <span class="o">=</span> <span class="n">t_test_grid</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="n">recent</span><span class="p">)</span>
<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">levene_stat</span><span class="p">,</span> <span class="n">p_values_levene</span> <span class="o">=</span> <span class="n">t_test_grid</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="n">recent</span><span class="p">,</span> <span class="n">mask_not_sig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
starting T-test
finished T-test
Starting for-loop...I am thinking
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/numpy/core/fromnumeric.py:2909: RuntimeWarning: Mean of empty slice.
  out=out, **kwargs)
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/numpy/core/_methods.py:80: RuntimeWarning: invalid value encountered in double_scalars
  ret = ret.dtype.type(ret / rcount)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
finished levene test
starting T-test
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/ipykernel_launcher.py:43: RuntimeWarning: invalid value encountered in greater
/g/data/v10/public/modules/agdc-py3-env/20171214/envs/agdc/lib/python3.6/site-packages/ipykernel_launcher.py:44: RuntimeWarning: invalid value encountered in greater
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
finished T-test
Starting for-loop...I am thinking
finished levene test
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#export out results as netcdf</span>
<span class="n">t_stat</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;t_stat.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
<span class="n">t_stat_masked</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;t_stat_masked.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

<span class="n">p_values</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;p_value.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

<span class="n">levene_stat</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;levene_stat.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
<span class="n">levene_stat_masked</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;levene_stat_masked.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
<span class="n">p_values_levene</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;p_values_levene.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

<span class="c1">#export out a -log(p_value) netcdf - we&#39;ll use it in the next step as it&#39;s easier to inpterpet than the 0-1 p_values.</span>
<span class="n">negLog_pValues</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
<span class="n">negLog_pValues</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;negLog_Pvalue.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

<span class="n">negLog_pValues_levene</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_values_levene</span><span class="p">)</span>
<span class="n">negLog_pValues_levene</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;negLog_Pvalue_levene.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="CompositeRGB-plot">
<h2>CompositeRGB plot<a class="headerlink" href="#CompositeRGB-plot" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#create an RGB xarray/netcdf that combines the p-values, the absolute difference in the means between periods,</span>
<span class="c1"># and the difference in standard deviation between the periods to create a single file that detects change</span>
<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">mean_diff</span><span class="o">.</span><span class="n">TV</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">mean_diff</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_yearly_std_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">TV</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1">#create rgb xarray object</span>
<span class="kn">from</span> <span class="nn">datacube.utils.geometry</span> <span class="k">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="k">import</span> <span class="n">Affine</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean_diff&#39;</span><span class="p">:</span><span class="n">mean_diff</span><span class="p">,</span> <span class="s1">&#39;std_diff&#39;</span><span class="p">:</span> <span class="n">mean_yearly_std_diff</span><span class="p">,</span> <span class="s1">&#39;negLog_pValue&#39;</span><span class="p">:</span> <span class="n">negLog_pValues</span><span class="p">}</span>
<span class="n">rgb_changeDetect</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;crs&#39;</span> <span class="p">:</span> <span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:3577&#39;</span><span class="p">),</span><span class="s1">&#39;affine&#39;</span><span class="p">:</span> <span class="n">fc_clean_ls8</span><span class="o">.</span><span class="n">affine</span> <span class="p">})</span>

<span class="c1">#export as a netcdf and a geotiff</span>
<span class="n">datacube</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write_dataset_to_netcdf</span><span class="p">(</span><span class="n">rgb_changeDetect</span><span class="p">,</span> <span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;rgb_changeDetect.nc&#39;</span><span class="p">)</span>
<span class="n">dataset_to_geotiff</span><span class="p">(</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;b_rgb_changeDetect.tif&#39;</span><span class="p">,</span><span class="n">rgb_changeDetect</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Exporting-geotiffs">
<h2>Exporting geotiffs<a class="headerlink" href="#Exporting-geotiffs" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">###############################################</span>
<span class="c1">#Import and prepare data for exporting/plotting</span>
<span class="c1">###############################################</span>

<span class="c1">#Import &#39;No Regeneration&#39; and slope netdcfs files as an xarray:</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;noRegen_intraannual.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="s1">&#39;time_bnds&#39;</span><span class="p">)</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>

<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_yearly_std_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">TV</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#Import slope here</span>
<span class="n">slope_recent</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;slope&#39;</span><span class="o">+</span><span class="n">start_of_regen</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">end_date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">slope_recent</span> <span class="o">=</span> <span class="n">slope_recent</span><span class="o">.</span><span class="n">TV</span>
<span class="n">slope_recent</span> <span class="o">=</span> <span class="n">slope_recent</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#import t_stat</span>
<span class="n">t_stat_masked_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;t_stat_masked.nc&#39;</span><span class="p">)</span>
<span class="n">t_stat_masked_np</span> <span class="o">=</span>  <span class="n">t_stat_masked_np</span><span class="o">.</span><span class="n">t_stats</span><span class="o">.</span><span class="n">values</span>

<span class="n">t_stat_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;t_stat.nc&#39;</span><span class="p">)</span>
<span class="n">t_stat_np</span> <span class="o">=</span>  <span class="n">t_stat_np</span><span class="o">.</span><span class="n">t_stats</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#import p_value</span>
<span class="n">negLog_Pvalue_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;p_value.nc&#39;</span><span class="p">)</span>
<span class="n">negLog_Pvalue_np</span> <span class="o">=</span>  <span class="n">negLog_Pvalue_np</span><span class="o">.</span><span class="n">p_value</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#import levene stats</span>
<span class="n">levene_stat_masked_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;levene_stat_masked.nc&#39;</span><span class="p">)</span>
<span class="n">levene_stat_masked_np</span> <span class="o">=</span>  <span class="n">levene_stat_masked_np</span><span class="o">.</span><span class="n">f_stats</span><span class="o">.</span><span class="n">values</span>

<span class="n">levene_stat_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;levene_stat.nc&#39;</span><span class="p">)</span>
<span class="n">levene_stat_np</span> <span class="o">=</span>  <span class="n">levene_stat_np</span><span class="o">.</span><span class="n">f_stats</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#import levene p_values</span>
<span class="n">negLog_Pvalue_levene_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;negLog_Pvalue_levene.nc&#39;</span><span class="p">)</span>
<span class="n">negLog_Pvalue_levene_np</span> <span class="o">=</span>  <span class="n">negLog_Pvalue_levene_np</span><span class="o">.</span><span class="n">p_value_f</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#import recent_mean minus baseline_mean</span>
<span class="n">mean_diff_np</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_diff_np</span> <span class="o">=</span> <span class="n">mean_diff_np</span><span class="o">.</span><span class="n">TV</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#export the masked xarrays as geotiffs. Transform object is being defined above</span>
<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;no_regen_intraannual_masked.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">no_regen_intraannual</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;mean_yearly_std_diff.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;slope_recent.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">slope_recent</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;t_stat_masked.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">t_stat_masked_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;t_stat.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">t_stat_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;negLog_p_value.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">negLog_Pvalue_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;levene_stat_masked.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">levene_stat_masked_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;levene_stat.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">levene_stat_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;negLog_p_value_levene.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">negLog_Pvalue_levene_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>

<span class="n">array_to_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;mean_difference.tif&#39;</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">mean_diff_np</span><span class="p">,</span>
                                    <span class="n">geo_transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
                                    <span class="n">projection</span> <span class="o">=</span> <span class="n">prj_wkt</span><span class="p">,</span>
                                    <span class="n">nodata_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float64</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Zonal-Statistics">
<h1>Zonal Statistics<a class="headerlink" href="#Zonal-Statistics" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>Use the exported ‘fc_clean_monthly.nc’ file to calculate the zonal statistics over polygons</div></blockquote>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#import the fractional cover netcdf file</span>
<span class="n">fc_monthly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s2">&quot;fc_clean_monthly.nc&quot;</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">ds_chunks</span><span class="p">})</span>

<span class="c1">#select out just the TV band</span>
<span class="n">TV_array</span> <span class="o">=</span> <span class="n">fc_monthly</span><span class="o">.</span><span class="n">TV</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">ds_chunks</span><span class="p">})</span>

<span class="c1">#create &#39;transform&#39; tuple to provide ndarray with geo-referencing data.</span>
<span class="c1">#The tuple contains 6 elements which correspond to:</span>
<span class="n">easting</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TV_array</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">W_E_pixelRes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TV_array</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">TV_array</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">rotation</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#(if image is &#39;north up&#39;)</span>
<span class="n">northing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TV_array</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">rotation1</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#(if image is &#39;north up&#39;)</span>
<span class="n">N_S_pixelRes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TV_array</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">TV_array</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">transform_zonal</span> <span class="o">=</span> <span class="p">(</span><span class="n">easting</span><span class="p">,</span> <span class="n">W_E_pixelRes</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">northing</span><span class="p">,</span> <span class="n">rotation1</span><span class="p">,</span> <span class="n">N_S_pixelRes</span><span class="p">)</span>

<span class="c1">#set the index of the geopandas datframe to be the Feature Name</span>
<span class="n">project_area_CEA</span> <span class="o">=</span> <span class="n">project_area_CEA</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>

<span class="c1"># create the zonal stats functions</span>
<span class="kn">import</span> <span class="nn">rasterstats</span> <span class="k">as</span> <span class="nn">rs</span>
<span class="k">def</span> <span class="nf">zonalStats_mean</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the zonal mean of all</span>
<span class="sd">    pixel values within each polygon&quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">zonal_stats</span><span class="p">(</span><span class="n">project_area_CEA</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform_zonal</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="n">mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">#extract just the values from the results, and convert &#39;None&#39; values to nan</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TV</span><span class="p">]</span> <span class="k">for</span> <span class="n">TV</span> <span class="ow">in</span> <span class="n">mean</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span>

<span class="k">def</span> <span class="nf">zonalStats_std</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the standard deviation</span>
<span class="sd">    of the pixel values within the polygon&quot;&quot;&quot;</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">zonal_stats</span><span class="p">(</span><span class="n">project_area_CEA</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform_zonal</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span>
        <span class="n">std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">[[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TV</span><span class="p">]</span> <span class="k">for</span> <span class="n">TV</span> <span class="ow">in</span> <span class="n">std</span><span class="p">]</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span>

<span class="c1">#use the zonal_stats functions to extract the mean and std from each sensor:</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">project_area_CEA</span><span class="p">)</span> <span class="c1">#number of polygons in the shapefile (defines the dimesions of the output)</span>
<span class="c1">#calculate zonal stats</span>
<span class="n">TV_mean</span> <span class="o">=</span> <span class="n">TV_array</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">zonalStats_mean</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">drop_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">TV_std</span> <span class="o">=</span> <span class="n">TV_array</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span><span class="n">zonalStats_std</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">drop_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1">#get unique identifier (project ids) and timeseries data from the inputs</span>
<span class="n">colnames</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">project_area_CEA</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">fc_monthly</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1">#define functions for cleaning up the results of the rasterstats operation</span>
<span class="k">def</span> <span class="nf">tidyresults</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;take the results of the zonal_stats function</span>
<span class="sd">    and place into a sensibly indexed dataframe&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="c1">#transpose</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="c1">#rename the columns to the timestamp</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">time</span><span class="p">)</span>
    <span class="c1">#x = x.replace(x[x&lt;=0], np.nan)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="c1">#place results into indexed dataframes using tidyresults function</span>
<span class="n">TV_mean_df</span> <span class="o">=</span> <span class="n">tidyresults</span><span class="p">(</span><span class="n">TV_mean</span><span class="p">)</span>
<span class="n">TV_std_df</span> <span class="o">=</span> <span class="n">tidyresults</span><span class="p">(</span><span class="n">TV_std</span><span class="p">)</span>

<span class="c1">#convert mean and std dfs into xarray for merging into a dataset</span>
<span class="n">TV_mean_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">TV_mean_df</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">feature_name</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">feature_name</span><span class="p">:</span> <span class="n">TV_mean_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">},</span> <span class="n">name</span><span class="o">=</span> <span class="s1">&#39;TV_mean&#39;</span><span class="p">)</span>
<span class="n">TV_std_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">TV_std_df</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">feature_name</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">feature_name</span><span class="p">:</span> <span class="n">TV_std_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">},</span> <span class="n">name</span><span class="o">=</span> <span class="s1">&#39;TV_std&#39;</span><span class="p">)</span>

<span class="c1">#join the mean and std dataArrays together</span>
<span class="n">TV_zonalStats</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">TV_mean_xr</span><span class="p">,</span> <span class="n">TV_std_xr</span><span class="p">])</span>

<span class="c1">#export out results as netcdf</span>
<span class="n">TV_zonalStats</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;results/&#39;</span> <span class="o">+</span> <span class="n">project_ID</span> <span class="o">+</span> <span class="s1">&#39;/netcdfs/&#39;</span> <span class="o">+</span> <span class="s1">&#39;FC_zonalstats_monthly.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/547/cb3058/.digitalearthau/20171214/local/lib/python3.6/site-packages/rasterstats/io.py:294: UserWarning: Setting nodata to -999; specify nodata explicitly
  warnings.warn(&#34;Setting nodata to -999; specify nodata explicitly&#34;)
</pre></div></div>
</div>
</div>
<div class="section" id="Reporting-and-plotting">
<h1>Reporting and plotting<a class="headerlink" href="#Reporting-and-plotting" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div>Create a pdf report that contains all of the above analysis in one easy document</div></blockquote>
<div class="section" id="Zonal-timeseries-plots">
<h2>Zonal timeseries plots<a class="headerlink" href="#Zonal-timeseries-plots" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">###################################################</span>
<span class="c1">#create plots of the zonally averaged TV timeseries</span>
<span class="c1">###################################################</span>
<span class="n">CEA_data_monthly</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TV_zonalStats</span><span class="p">[</span><span class="n">feature_name</span><span class="p">])):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">TV_zonalStats</span><span class="o">.</span><span class="n">isel</span><span class="p">([</span><span class="s1">&#39;TV_mean&#39;</span><span class="p">,</span><span class="s1">&#39;TV_std&#39;</span><span class="p">],</span> <span class="o">**</span><span class="p">{</span><span class="n">feature_name</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
    <span class="n">CEA_data_monthly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#extract the unique names of each polygon</span>
<span class="n">CEA_monthly</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">TV_zonalStats</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1">#zip the both the CEAs and CEA_data together as a dictionary</span>
<span class="n">monthly_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">CEA_monthly</span><span class="p">,</span><span class="n">CEA_data_monthly</span><span class="p">))</span>

<span class="c1">#create a function for generating the plots</span>
<span class="k">def</span> <span class="nf">plotResults</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a function for plotting up the results of the</span>
<span class="sd">    fractional cover change and exporting it out as pdf &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>
    <span class="n">TV</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TV_mean</span>
    <span class="n">TV_error</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TV_std</span>

    <span class="c1">#plot TV</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TV</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#228b22&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">TV</span><span class="o">-</span><span class="n">TV_error</span><span class="p">,</span> <span class="n">TV</span><span class="o">+</span><span class="n">TV_error</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#228b22&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#32cd32&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of TV Cover (%)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;, TV&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_ts_pdf</span> <span class="o">+</span><span class="n">title</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="c1">#loop over the dictionaries and create the plots</span>
<span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">plotResults</span><span class="p">(</span><span class="n">monthly_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_monthly&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">monthly_dict</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;Canberra East&#39;: None, &#39;Canberra West&#39;: None}
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_33_1.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_33_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_33_2.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_33_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#merge all the exported timeseries pdfs into one document</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="k">import</span> <span class="n">PdfFileMerger</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">results_ts_pdf</span><span class="p">)</span> <span class="c1">#navigate to directory</span>
<span class="n">pdfs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span> <span class="c1">#list all the pdfs in the directory</span>
<span class="n">pdfs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdfs</span><span class="p">)</span>

<span class="c1">#merge the pdfs</span>
<span class="n">merger</span> <span class="o">=</span> <span class="n">PdfFileMerger</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdfs</span><span class="p">:</span>
    <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
<span class="n">merger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;b_all_timeseries.pdf&quot;</span><span class="p">)</span>

<span class="c1">#move the merged pdf into the directory above it (helps with merge of all the results later)</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">results_ts_pdf</span><span class="o">+</span><span class="s2">&quot;b_all_timeseries.pdf&quot;</span><span class="p">,</span> <span class="n">results_pdf</span><span class="o">+</span><span class="s1">&#39;b_all_timeseries.pdf&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span> <span class="c1">#navigate back to our wd</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Pixel-wise-plots">
<h2>Pixel-wise plots<a class="headerlink" href="#Pixel-wise-plots" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">########################</span>
<span class="c1">#Create pixel-wise plots</span>
<span class="c1">########################</span>

<span class="c1">#import files</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;noRegen_intraannual.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">no_regen_intraannual</span> <span class="o">=</span> <span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="s1">&#39;time_bnds&#39;</span><span class="p">)</span>

<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_yearly_std_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">TV</span>
<span class="n">mean_yearly_std_diff</span> <span class="o">=</span> <span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;mean_diff.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">mean_diff</span><span class="o">.</span><span class="n">TV</span>
<span class="n">mean_diff</span> <span class="o">=</span> <span class="n">mean_diff</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="n">p_value</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;p_value.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">p_value_levene</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;p_values_levene.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">rgb_changeDetect</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">results_netcdf</span> <span class="o">+</span> <span class="s1">&#39;rgb_changeDetect.nc&#39;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#create a plot showing the Std. Dev,. difference and mean difference maps, as well as the P-values for those changes.</span>

<span class="c1">#generate some x and y limits so the plotting is constrained</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">project_area_CEA</span><span class="o">.</span><span class="n">total_bounds</span>
<span class="c1">#longitude</span>
<span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">xlim</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>  <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">xlim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="c1">#latitude</span>
<span class="n">ind1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

<span class="c1">#plot</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">mean_yearly_std_diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference in Std. Dev. (baseline - recent)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">p_value_levene</span><span class="o">.</span><span class="n">p_value_f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;P values of Levene test&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
<span class="n">mean_diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;BrBG&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference in mean TV (recent - baseline)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">p_value</span><span class="o">.</span><span class="n">p_value</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;P_values of mean TV&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_pdf</span> <span class="o">+</span> <span class="s2">&quot;c_pixel_wise_plots.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
FutureWarning: &#39;pandas.tseries.converter.register&#39; has been moved and renamed to &#39;pandas.plotting.register_matplotlib_converters&#39;.  [utils.py:51]
MatplotlibDeprecationWarning: Adding an axes using the same arguments as a previous axes currently reuses the earlier instance.  In a future version, a new instance will always be created and returned.  Meanwhile, this warning can be suppressed, and the future behavior ensured, by passing a unique label to each axes instance. [deprecation.py:106]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_37_1.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_37_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Calculate the number of cells that are at a high-risk of no-regeneration for the std dev method</span>
<span class="c1">#we want to calculate this for the method where I do take account of the p-values_levene, and the where we don&#39;t</span>

<span class="c1">#Method ingnoring levene stats results</span>
<span class="n">ones</span> <span class="o">=</span> <span class="p">(</span><span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">noRegen</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">no_of_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">noRegen</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">risk_percent</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ones</span><span class="o">/</span><span class="n">no_of_cells</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">risk_percent</span> <span class="o">=</span> <span class="n">risk_percent</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1">#Method incorporating levene stats results</span>
<span class="n">ones_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">noRegen</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_value_levene</span><span class="o">.</span><span class="n">p_value_f</span><span class="o">&lt;=</span><span class="mf">0.10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">risk_percent_masked</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ones_masked</span><span class="o">/</span><span class="n">no_of_cells</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">risk_percent_masked</span> <span class="o">=</span> <span class="n">risk_percent_masked</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk_percent</span> <span class="o">+</span><span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f cells are high-risk (red)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">noRegen</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn_r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
        <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;High Risk of No-Regeneration (Std. Dev. method)&#39;</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk_percent_masked</span> <span class="o">+</span><span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f cells are high-risk (red)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">no_regen_intraannual</span><span class="o">.</span><span class="n">noRegen</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_value_levene</span><span class="o">.</span><span class="n">p_value_f</span><span class="o">&lt;=</span><span class="mf">0.10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn_r&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
        <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;masked with levene stats (p=0.1))&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_pdf</span> <span class="o">+</span> <span class="s2">&quot;d_no_regeneration_stdDev_method.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
MatplotlibDeprecationWarning: Adding an axes using the same arguments as a previous axes currently reuses the earlier instance.  In a future version, a new instance will always be created and returned.  Meanwhile, this warning can be suppressed, and the future behavior ensured, by passing a unique label to each axes instance. [deprecation.py:106]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_39_1.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_39_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#make the final plot that has 3 of the layers combined</span>
<span class="kn">from</span> <span class="nn">skimage.exposure</span> <span class="k">import</span> <span class="n">rescale_intensity</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">exposure</span>
<span class="kn">from</span> <span class="nn">matplotlib.offsetbox</span> <span class="k">import</span> <span class="p">(</span><span class="n">TextArea</span><span class="p">,</span> <span class="n">DrawingArea</span><span class="p">,</span> <span class="n">OffsetImage</span><span class="p">,</span>
                                  <span class="n">AnnotationBbox</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,:,</span><span class="n">b</span><span class="p">]</span>
<span class="c1">#     pl, pu = np.percentile(tmp[np.isfinite(tmp)], (10., 90.))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">pl</span><span class="p">,</span> <span class="n">pu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">sd</span>
    <span class="n">img</span><span class="p">[:,:,</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">rescale_intensity</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">pu</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>

<span class="n">xmin</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">200</span>
<span class="n">xmax</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">200</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">200</span>
<span class="n">ymax</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">200</span>

<span class="c1"># plt.figure(figsize = (13.0, 13.0))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">13.0</span><span class="p">,</span> <span class="mf">13.0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                          <span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rgb_changeDetect</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;RGB Change Detection. Red=mean_diff, green=StD_diff, blue=p_value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="s2">&quot;White = strong regen; Blues =&#39;clearing&#39;; Green&amp;Reds = no change; Pink = ambiguous&quot;</span> <span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Eastings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Northings&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="c1">#--Add an image to the plot---------------------------------</span>
<span class="c1"># rgb_tri = plt.imread((data+&#39;rgbtri.png&#39;), format=&#39;png&#39;)</span>
<span class="c1"># newax = fig.add_axes([0.745, 0.215, 0.15, 0.15], zorder=2)</span>
<span class="c1"># newax.imshow(rgb_tri)</span>
<span class="c1"># newax.axis(&#39;off&#39;)</span>
<span class="c1">#-----------------------------------------------------------</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_pdf</span> <span class="o">+</span> <span class="s2">&quot;e_rgb_changeDetect.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
RuntimeWarning: invalid value encountered in true_divide [exposure.py:297]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_40_1.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_40_1.png" />
</div>
</div>
</div>
<div class="section" id="True-colour-plot">
<h2>True colour plot<a class="headerlink" href="#True-colour-plot" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#import a recent landsat image to use for a truecolour plot</span>
<span class="n">query_new</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2018-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2018-03-28&#39;</span><span class="p">),}</span>
<span class="n">query_new</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent_long</span>
<span class="n">query_new</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extent_lat</span>

<span class="n">recent_image</span> <span class="o">=</span> <span class="n">load_clearlandsat</span><span class="p">(</span><span class="n">dc</span><span class="o">=</span><span class="n">datacube</span><span class="o">.</span><span class="n">Datacube</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="s1">&#39;loadrecentimage&#39;</span><span class="p">),</span>
                          <span class="n">sensors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ls8&#39;</span><span class="p">],</span>
                          <span class="n">query</span><span class="o">=</span><span class="n">query_new</span><span class="p">,</span>
                          <span class="n">masked_prop</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="n">red</span> <span class="o">=</span> <span class="n">recent_image</span><span class="o">.</span><span class="n">red</span>
<span class="n">green</span> <span class="o">=</span> <span class="n">recent_image</span><span class="o">.</span><span class="n">green</span>
<span class="n">blue</span> <span class="o">=</span> <span class="n">recent_image</span><span class="o">.</span><span class="n">blue</span>

<span class="kn">from</span> <span class="nn">datacube.utils.geometry</span> <span class="k">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="k">import</span> <span class="n">Affine</span>
<span class="n">rgb</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span><span class="n">red</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span><span class="n">green</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span><span class="n">blue</span><span class="p">}</span>
<span class="n">rgb_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;crs&#39;</span> <span class="p">:</span> <span class="n">CRS</span><span class="p">(</span><span class="s1">&#39;EPSG:3577&#39;</span><span class="p">),</span><span class="s1">&#39;affine&#39;</span><span class="p">:</span> <span class="n">recent_image</span><span class="o">.</span><span class="n">affine</span> <span class="p">})</span>

<span class="c1">#export the truecolour plot as a geotiff</span>
<span class="n">dataset_to_geotiff</span><span class="p">(</span><span class="n">tiff_results</span> <span class="o">+</span> <span class="s1">&#39;a_trueColour.tif&#39;</span><span class="p">,</span><span class="n">rgb_xr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading ls8 PQ
    Loading 1 filtered ls8 timesteps
Combining and sorting ls5, ls7 and ls8 data
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#create plot using the custom function &#39;three_band_image&#39;</span>
<span class="n">plt</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">three_band_image</span><span class="p">(</span><span class="n">recent_image</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">],</span> <span class="n">contrast_enhance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#bring in shapefile</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">project_area_CEA_albers_loc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shapefile</span><span class="p">:</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">shapefile</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="c1">#create a long list of colors to iterate over in the plot shapefile code</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%06X</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFFFF</span><span class="p">))</span>

<span class="c1">#plot the shapefile</span>
<span class="kn">from</span> <span class="nn">descartes</span> <span class="k">import</span> <span class="n">PolygonPatch</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">PolygonPatch</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Label&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PatchCollection</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="p">[</span><span class="n">color</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">],</span> <span class="n">match_original</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1">#create a nice, custom legend</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="n">texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project_area_CEA</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span> <span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1">#make it pretty</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Summer-time 2018 True Colour plot of AOI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Eastings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Northings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_pdf</span> <span class="o">+</span> <span class="s2">&quot;a_true_colour.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_43_0.png" src="../../_images/notebooks_09_Workflows_Fractional_Cover_Change_Detection_43_0.png" />
</div>
</div>
</div>
<div class="section" id="Merge-all-pdfs">
<h2>Merge all pdfs<a class="headerlink" href="#Merge-all-pdfs" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#merge all the pdfs into a final results document</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="k">import</span> <span class="n">PdfFileMerger</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">results_pdf</span><span class="p">)</span>

<span class="c1">#get list of files in the directory that are pdfs</span>
<span class="n">pdfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
        <span class="n">pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<span class="n">pdfs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdfs</span><span class="p">)</span>

<span class="c1">#merge pdfs</span>
<span class="n">merger</span> <span class="o">=</span> <span class="n">PdfFileMerger</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="n">pdfs</span><span class="p">:</span>
    <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

<span class="n">merger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;final_results.pdf&quot;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Fractional_Cover_Percentiles.html" class="btn btn-neutral float-right" title="Fractional Cover Percentiles" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Sun_glint_identification_and_removal.html" class="btn btn-neutral float-left" title="Sun glint identification and removal" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Geoscience Australia

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-113800428-1', 'auto');
    ga('send', 'pageview');
    </script>

    
  


<!-- Theme Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113800428-1"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 
 gtag('config', 'UA-113800428-1');
</script>

    
  


</body>
</html>